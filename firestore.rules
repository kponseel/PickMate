rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ──────────────────────────────────────────────
    // Helper functions
    // ──────────────────────────────────────────────

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    // ──────────────────────────────────────────────
    // Users collection
    // Each user can only read/write their own doc
    // ──────────────────────────────────────────────
    match /users/{userId} {
      allow read: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if false;
    }

    // ──────────────────────────────────────────────
    // Decisions collection
    // - Anyone can read (for public voting links)
    // - Only authenticated users can create
    // - Only the owner can update/delete
    // ──────────────────────────────────────────────
    match /decisions/{decisionId} {
      // Public read for shareable voting links
      allow read: if true;

      // Only authenticated users can create decisions
      allow create: if isSignedIn() &&
        request.resource.data.ownerId == request.auth.uid;

      // Only owner can update/delete
      allow update: if isOwner(resource.data.ownerId);
      allow delete: if isOwner(resource.data.ownerId);

      // ──────────────────────────────────────────────
      // Options subcollection
      // - Anyone can read (for voting)
      // - Only owner can write
      // ──────────────────────────────────────────────
      match /options/{optionId} {
        allow read: if true;

        allow create, update, delete: if isSignedIn() &&
          get(/databases/$(database)/documents/decisions/$(decisionId)).data.ownerId == request.auth.uid;
      }

      // ──────────────────────────────────────────────
      // Voters subcollection
      // - Anyone can read/create/update (for public voting)
      // - Voters create their own doc with their ratings
      // ──────────────────────────────────────────────
      match /voters/{voterId} {
        allow read: if true;
        allow create: if true;
        allow update: if true;

        // Ratings subcollection within voter doc
        match /ratings/{optionId} {
          allow read: if true;
          allow create: if true;
          allow update: if true;
        }
      }
    }
  }
}
