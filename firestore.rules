rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ──────────────────────────────────────────────
    // Helper functions
    // ──────────────────────────────────────────────

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // Check if the current user belongs to a given couple
    function isCoupleMemb(coupleId) {
      return isSignedIn() &&
        request.auth.uid in get(/databases/$(database)/documents/couples/$(coupleId)).data.members;
    }

    // ──────────────────────────────────────────────
    // Users collection
    // Each user can only read/write their own doc
    // ──────────────────────────────────────────────
    match /users/{userId} {
      allow read: if isSignedIn() && isOwner(userId);
      allow create: if isSignedIn() && isOwner(userId);
      allow update: if isSignedIn() && isOwner(userId);
      allow delete: if false; // users cannot delete their profile doc
    }

    // ──────────────────────────────────────────────
    // Couples collection
    // Only members of the couple can read it.
    // Any signed-in user can create (to start a couple).
    // Only members can update (to add second member).
    // ──────────────────────────────────────────────
    match /couples/{coupleId} {
      allow read: if isSignedIn() &&
        request.auth.uid in resource.data.members;

      allow create: if isSignedIn() &&
        request.resource.data.members.size() == 1 &&
        request.auth.uid in request.resource.data.members;

      allow update: if isSignedIn() &&
        (request.auth.uid in resource.data.members ||
         // Allow a new member to join via invite code
         request.resource.data.members.size() == 2);

      allow delete: if isSignedIn() &&
        request.auth.uid in resource.data.members;
    }

    // ──────────────────────────────────────────────
    // Decisions collection
    // Only couple members can CRUD decisions
    // ──────────────────────────────────────────────
    match /decisions/{decisionId} {
      allow read: if isSignedIn() &&
        isCoupleMemb(resource.data.coupleId);

      allow create: if isSignedIn() &&
        isCoupleMemb(request.resource.data.coupleId);

      allow update: if isSignedIn() &&
        isCoupleMemb(resource.data.coupleId);

      allow delete: if isSignedIn() &&
        isCoupleMemb(resource.data.coupleId);
    }

    // ──────────────────────────────────────────────
    // Proposals collection
    // Access controlled via the parent decision's couple
    // ──────────────────────────────────────────────
    match /proposals/{proposalId} {
      allow read: if isSignedIn();
      // We validate the decision belongs to user's couple on the client side.
      // A stricter rule would fetch the decision doc, but that costs reads.
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    // ──────────────────────────────────────────────
    // Ratings collection
    // Users can only write their own ratings (enforced by doc ID pattern)
    // ──────────────────────────────────────────────
    match /ratings/{ratingId} {
      allow read: if isSignedIn();

      allow create, update: if isSignedIn() &&
        request.resource.data.userId == request.auth.uid &&
        request.resource.data.stars >= 1 &&
        request.resource.data.stars <= 3;

      allow delete: if isSignedIn() &&
        resource.data.userId == request.auth.uid;
    }
  }
}
